name: ğŸª© Convert Markdown to Refynd Blog HTML

on:
  # push:
  #   paths:
  #     - "drafts/blogs/*.md"
  #   branches:
  #     - main
  workflow_dispatch:  # âœ… allow manual trigger from Actions UI

permissions:
  contents: write

jobs:
  build:
    name: Convert Markdown â†’ Refynd HTML
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“¦ Install Markdown Converter
        run: npm install -g showdown js-beautify

      - name: ğŸ§  Convert Markdown Blogs to HTML (Refynd Format)
        shell: bash
        run: |
          mkdir -p blogs
          for file in drafts/blogs/*.md; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .md)
            echo "ğŸª¶ Converting $filename.md â†’ blogs/$filename.html"

            # Convert Markdown content to HTML
            content=$(showdown makehtml -i "$file")

            # Write HTML safely using printf (no heredoc issues)
            printf '%s\n' "<!DOCTYPE html>" \
            "<html lang=\"en\">" \
            "<head>" \
            "  <meta charset=\"UTF-8\" />" \
            "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />" \
            "  <title>${filename^} | Refynd</title>" \
            "  <link rel=\"stylesheet\" href=\"../assets/css/style.css\" />" \
            "  <script src=\"https://unpkg.com/lucide@latest\"></script>" \
            "</head>" \
            "<body>" \
            "  <!-- Sidebar dynamically injected by main.js -->" \
            "  <main class=\"main-content\" id=\"main-content\">" \
            "    <header>" \
            "      <h1>${filename^}</h1>" \
            "      <p>A Refynd Glass Blog</p>" \
            "    </header>" \
            "    <article class=\"glass-blog\">" \
            "      $content" \
            "    </article>" \
            "  </main>" \
            "  <script src=\"../assets/js/main.js\"></script>" \
            "</body>" \
            "</html>" > "blogs/$filename.html"
          done

      - name: ğŸ§¹ Beautify HTML Output
        run: js-beautify -r blogs/*.html || true

      - name: ğŸš€ Commit and Push Changes
        run: |
          git config user.name "Refynd Bot"
          git config user.email "bot@refynd.io"
          git add blogs/
          git diff --cached --quiet || git commit -m "ğŸª© Auto-generated blog pages from Markdown"
          git push
