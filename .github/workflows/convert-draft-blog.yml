name: Convert Markdown to Refynd Blog HTML

on:
  # push:
  #   paths:
  #     - "drafts/blogs/*.md"
  #   branches:
  #     - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Markdown Tools
        run: npm install -g showdown js-beautify

      - name: Upload Installed Tools (cache for next job)
        uses: actions/upload-artifact@v4
        with:
          name: repo-files
          path: .
          retention-days: 1

  convert:
    name: Convert Markdown → Refynd HTML
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Markdown Converter
        run: npm install -g showdown js-beautify

      - name: Generate Blog HTMLs
        shell: bash
        run: |
          mkdir -p blogs bin/blogs
          for file in drafts/blogs/*.md; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .md)
            echo "Converting $filename.md → blogs/$filename.html"

            content=$(showdown makehtml -i "$file")

            printf '%s\n' "<!DOCTYPE html>" \
            "<html lang=\"en\">" \
            "<head>" \
            "  <meta charset=\"UTF-8\" />" \
            "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />" \
            "  <title>${filename^} | Refynd</title>" \
            "  <link rel=\"stylesheet\" href=\"../assets/css/style.css\" />" \
            "  <script src=\"https://unpkg.com/lucide@latest\"></script>" \
            "</head>" \
            "<body>" \
            "  <!-- Sidebar dynamically injected by main.js -->" \
            "  <main class=\"main-content\" id=\"main-content\">" \
            "    <header>" \
            "      <h1>${filename^}</h1>" \
            "      <p>A Refynd Glass Blog</p>" \
            "    </header>" \
            "    <article class=\"glass-blog\">" \
            "      $content" \
            "    </article>" \
            "  </main>" \
            "  <script src=\"../assets/js/main.js\"></script>" \
            "</body>" \
            "</html>" > "blogs/$filename.html"

            echo "Moving processed markdown to bin/blogs/"
            mv "$file" "bin/blogs/$filename.md"
          done

      - name: Upload Converted Files
        uses: actions/upload-artifact@v4
        with:
          name: converted-files
          path: |
            blogs/
            bin/blogs/
          retention-days: 1

  publish:
    name: Beautify & Commit
    runs-on: ubuntu-latest
    needs: convert

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Converted Files
        uses: actions/download-artifact@v4
        with:
          name: converted-files
          path: .

      - name: Beautify HTML Output
        run: js-beautify -r blogs/*.html || true

      - name: Commit and Push Changes
        run: |
          git config user.name "refynd bot"
          git config user.email "bot@refynd"
          git add blogs/ bin/blogs/
          git diff --cached --quiet || git commit -m "Auto-generated blog pages from Markdown"
          git push
